<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Nhân viên - Quản lý đơn hàng</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        background: #f8f8f8;
        margin: 0;
      }
      header {
        background: #d6001c;
        color: white;
        padding: 15px 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      header h1 {
        margin: 0;
        font-size: 28px;
      }
      .logout-btn {
        background: white;
        color: #d6001c;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
      }
      .container {
        max-width: 1400px;
        margin: 30px auto;
        padding: 0 20px;
      }
      h2 {
        color: #d6001c;
        text-align: center;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-top: 20px;
      }
      th,
      td {
        padding: 12px;
        text-align: center;
        border: 1px solid #ddd;
      }
      th {
        background: #d6001c;
        color: white;
      }
      .status-cho-duyet {
        color: orange;
        font-weight: bold;
      }
      .status-da-nhan {
        color: blue;
        font-weight: bold;
      }
      .status-dang-giao {
        color: #d6001c;
        font-weight: bold;
      }
      .status-hoan-thanh {
        color: green;
        font-weight: bold;
      }
      .status-huy {
        color: gray;
        font-weight: bold;
        text-decoration: line-through;
      }
      .btn {
        padding: 6px 12px;
        margin: 2px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 13px;
        color: white;
      }
      .btn-nhan {
        background: #28a745;
      }
      .btn-dang-giao {
        background: #007bff;
      }
      .btn-hoan-thanh {
        background: #17a2b8;
      }
      .btn-huy {
        background: #dc3545;
      }
      .btn:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      .empty {
        text-align: center;
        color: #666;
        padding: 40px;
        font-size: 18px;
      }
    </style>
  </head>
  <body>
    <script src="img-config.js"></script>
    <header>
      <h1>Jollibee - Nhân viên</h1>
      <button class="logout-btn" onclick="logout()">Đăng xuất</button>
    </header>

    <div class="container">
      <h2>Quản lý đơn hàng</h2>
      <p id="userInfo" style="text-align: center; color: #444"></p>

      <table id="orderTable">
        <thead>
          <tr>
            <th>Mã Đơn</th>
            <th>Khách hàng</th>
            <th>Tổng tiền</th>
            <th>Trạng thái</th>
            <th>Ngày đặt</th>
            <th>Hành động</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Modal Hủy đơn -->
    <div
      id="cancelModal"
      style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
        justify-content: center;
        align-items: center;
        z-index: 1000;
      "
    >
      <div
        style="
          background: white;
          padding: 30px;
          border-radius: 10px;
          width: 450px;
          max-width: 90%;
        "
      >
        <h3 style="color: #d6001c; margin-top: 0">Hủy đơn hàng</h3>
        <p>Vui lòng nhập lý do hủy:</p>
        <textarea
          id="lyDoInput"
          rows="4"
          style="
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            resize: vertical;
          "
        ></textarea>
        <div style="margin-top: 20px; text-align: right">
          <button
            onclick="closeCancelModal()"
            style="
              padding: 8px 16px;
              margin-right: 10px;
              background: #6c757d;
              color: white;
              border: none;
              border-radius: 6px;
              cursor: pointer;
            "
          >
            Hủy
          </button>
          <button
            onclick="confirmCancel()"
            style="
              padding: 8px 16px;
              background: #dc3545;
              color: white;
              border: none;
              border-radius: 6px;
              cursor: pointer;
            "
          >
            Xác nhận hủy
          </button>
        </div>
      </div>
    </div>

    <script>
      const currentUser = JSON.parse(localStorage.getItem("user") || "{}");
      if (!currentUser || !["nhanvien", "admin"].includes(currentUser.vaiTro)) {
        alert("Bạn không có quyền truy cập trang Nhân viên!");
        window.location.href = "login.html";
      }

      document.getElementById("userInfo").innerHTML = `Xin chào <strong>${
        currentUser.hoTen || "Nhân viên"
      } (${currentUser.vaiTro.toUpperCase()})</strong>!`;

      const API_ORDERS = window.API_BASE + "/api/donhang";
      const API_UPDATE_STATUS = window.API_BASE + "/api/donhang/";
      const API_SINGLE_ORDER = window.API_BASE + "/api/donhang/";

      let currentCancelOrder = null;

      async function loadOrders() {
        try {
          const res = await fetch(API_ORDERS);
          if (!res.ok) throw new Error("Không tải được đơn hàng");
          const orders = await res.json();

          const tbody = document.querySelector("#orderTable tbody");
          tbody.innerHTML = "";

          if (orders.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="6" class="empty">Hiện chưa có đơn hàng nào</td></tr>';
            return;
          }

          orders.forEach((order) => {
            const statusClass =
              {
                cho_duyet: "status-cho-duyet",
                da_nhan: "status-da-nhan",
                dang_giao: "status-dang-giao",
                hoan_thanh: "status-hoan-thanh",
                da_huy: "status-huy",
              }[order.TrangThai] || "";

            const row = document.createElement("tr");
            row.innerHTML = `
            <td>${order.MaDonHang}</td>
            <td>${order.HoTen || "Khách vãng lai"}</td>
            <td>${order.TongTien.toLocaleString()}đ</td>
            <td class="${statusClass}">${getStatusText(order.TrangThai)}</td>
            <td>${new Date(order.NgayDat).toLocaleString()}</td>
            <td>
              ${
                order.TrangThai === "cho_duyet"
                  ? `
                <button class="btn btn-nhan" onclick="updateStatus('${order.MaDonHang}', 'da_nhan')">Nhận đơn</button>
              `
                  : ""
              }
              ${
                order.TrangThai === "da_nhan"
                  ? `
                <button class="btn btn-dang-giao" onclick="updateStatus('${order.MaDonHang}', 'dang_giao')">Chuyển đang giao</button>
                <button class="btn btn-huy" onclick="openCancelModal('${order.MaDonHang}')">Hủy</button>
              `
                  : ""
              }
              ${
                order.TrangThai === "dang_giao"
                  ? `
                <button class="btn btn-hoan-thanh" onclick="updateStatus('${order.MaDonHang}', 'hoan_thanh')">Hoàn thành</button>
              `
                  : ""
              }
            </td>
          `;
            tbody.appendChild(row);
          });
        } catch (err) {
          alert("Lỗi tải đơn hàng: " + err.message);
        }
      }

      function getStatusText(status) {
        const map = {
          cho_duyet: "Chờ duyệt",
          da_nhan: "Đã nhận",
          dang_giao: "Đang giao",
          hoan_thanh: "Hoàn thành",
          da_huy: "Đã hủy",
        };
        return map[status] || status;
      }

      async function updateStatus(maDonHang, trangThaiMoi, lyDoHuy = null) {
        if (
          !confirm(
            `Xác nhận chuyển trạng thái đơn ${maDonHang} thành "${getStatusText(
              trangThaiMoi
            )}"?`
          )
        )
          return;

        try {
          // Chuẩn bị body gửi đi
          const body = {
            TrangThai: trangThaiMoi,
          };

          // Đặc biệt: Khi NHẬN ĐƠN → thêm MaNhanVien = MaUser của nhân viên hiện tại
          if (trangThaiMoi === "da_nhan") {
            body.MaNhanVien = currentUser.MaUser;
          }

          // Nếu hủy đơn → thêm lý do
          if (lyDoHuy) {
            body.LyDoHuy = lyDoHuy.trim();
          }

          const res = await fetch(`${API_UPDATE_STATUS}${maDonHang}`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              // Nếu bạn dùng JWT thì thêm dòng này (tùy backend yêu cầu)
              // Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
            body: JSON.stringify(body),
          });

          const result = await res.json();
          if (!res.ok)
            throw new Error(result.message || "Lỗi cập nhật trạng thái");

          alert("Cập nhật thành công!");

          // Gửi thông báo cho khách hàng nếu cần
          if (
            ["da_nhan", "dang_giao", "hoan_thanh", "da_huy"].includes(
              trangThaiMoi
            )
          ) {
            await sendNotification(maDonHang, trangThaiMoi, lyDoHuy);
          }

          loadOrders(); // Reload danh sách
        } catch (err) {
          alert("Lỗi: " + err.message);
        }
      }
      async function sendNotification(maDonHang, trangThai, lyDoHuy = null) {
        const res = await fetch(`${API_SINGLE_ORDER}${maDonHang}`);
        const order = await res.json();

        if (!order.MaUser) return;

        const messages = {
          da_nhan: "Đơn hàng của bạn đã được nhân viên nhận và đang xử lý!",
          dang_giao: "Đơn hàng của bạn đang được giao. Vui lòng chờ shipper!",
          hoan_thanh: "Đơn hàng đã giao thành công. Cảm ơn bạn!",
          da_huy: `Đơn hàng của bạn đã bị hủy. Lý do: ${
            lyDoHuy || "Không có lý do cụ thể"
          }. Vui lòng liên hệ hỗ trợ nếu cần.`,
        };

        await fetch(window.API_BASE + "/api/notification", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            MaUser: order.MaUser,
            MaDonHang: maDonHang,
            NoiDung: messages[trangThai] || "Trạng thái đơn hàng đã thay đổi",
          }),
        });
      }

      function openCancelModal(maDonHang) {
        currentCancelOrder = maDonHang;
        document.getElementById("cancelModal").style.display = "flex";
        document.getElementById("lyDoInput").value = "";
      }

      function closeCancelModal() {
        document.getElementById("cancelModal").style.display = "none";
        currentCancelOrder = null;
      }

      async function confirmCancel() {
        const lyDo = document.getElementById("lyDoInput").value.trim();
        if (!lyDo) return alert("Vui lòng nhập lý do hủy!");

        closeCancelModal();
        await updateStatus(currentCancelOrder, "da_huy", lyDo);
      }

      function logout() {
        if (confirm("Bạn muốn đăng xuất?")) {
          localStorage.clear();
          window.location.href = "login.html";
        }
      }

      // Load khi mở trang
      loadOrders();
    </script>
  </body>
</html>
