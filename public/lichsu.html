<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>L·ªãch s·ª≠ ƒë∆°n h√†ng - Jollibee Clone</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        background: #fff7f7;
        margin: 0;
      }
      header {
        background: #d6001c;
        padding: 15px 40px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        color: white;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
      }
      header .logo {
        font-size: 28px;
        font-weight: bold;
      }
      header nav a {
        color: white;
        margin-left: 25px;
        text-decoration: none;
        font-size: 18px;
        transition: 0.2s;
      }
      header nav a:hover {
        color: #ffe600;
      }
      .container {
        max-width: 1200px;
        background: white;
        margin: 30px auto;
        padding: 25px;
        border-radius: 16px;
        box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
      }
      h2 {
        color: #b30015;
        margin-bottom: 15px;
        font-size: 26px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }
      th,
      td {
        padding: 12px;
        border-bottom: 1px solid #eee;
        text-align: center;
      }
      th {
        background: #ffe2e4;
        font-size: 16px;
      }
      .status {
        font-weight: bold;
      }
      .status.hoan_thanh {
        color: #009900;
      }
      .status.huy {
        color: #888;
        text-decoration: line-through;
      }
      button {
        padding: 6px 12px;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        font-size: 14px;
        margin: 2px;
        transition: 0.2s;
      }
      button:hover {
        opacity: 0.9;
      }
      .btn-danhgia {
        background: #28a745;
        color: white;
      }
      .btn-da-danhgia {
        background: #6c757d;
        color: white;
        cursor: not-allowed;
      }
      .btn-xem {
        background: #007bff;
        color: white;
      }
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.6);
      }
      .modal-content {
        background: white;
        margin: 15% auto;
        padding: 30px;
        border-radius: 12px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      }
      .close {
        float: right;
        font-size: 30px;
        cursor: pointer;
        color: #d6001c;
      }
      .stars {
        font-size: 40px;
        text-align: center;
        margin: 20px 0;
      }
      .star {
        color: #ddd;
        cursor: pointer;
        transition: color 0.2s;
      }
      .star.active {
        color: #ffd700;
      }
      .form-group {
        margin: 15px 0;
      }
      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: bold;
      }
      .form-group textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 6px;
        resize: vertical;
      }
      .submit-btn {
        background: #d6001c;
        color: white;
        padding: 12px 30px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        width: 100%;
        font-size: 16px;
      }
      .submit-btn:hover {
        background: #b30015;
      }
    </style>
  </head>
  <body>
    <script src="img-config.js"></script>
    <header>
      <div class="logo">Jollibee Clone</div>
      <nav>
        <a href="index.html">Trang ch·ªß</a>
        <a href="thucdon.html">Th·ª±c ƒë∆°n</a>
        <a href="khuyenmai.html">Khuy·∫øn m√£i</a>
        <a href="lienhe.html">Li√™n h·ªá</a>
        <a href="theodoi.html" style="color: yellow">Theo d√µi ƒë∆°n</a>
        <a href="lichsu.html">L·ªãch s·ª≠ ƒë∆°n h√†ng</a>

        <a
          id="cart-btn"
          href="giohang.html"
          style="
            background: yellow;
            padding: 6px 12px;
            border-radius: 6px;
            color: black !important;
            font-weight: bold;
            margin-left: 15px;
          "
        >
          üõí Gi·ªè h√†ng (<span id="cart-count">0</span>)
        </a>

        <!-- Khu ƒëƒÉng nh·∫≠p -->
        <span id="user-area" style="margin-left: 20px; font-size: 18px">
          <!-- n·ªôi dung s·∫Ω t·ª± thay ƒë·ªïi b·∫±ng JavaScript -->
        </span>
      </nav>
    </header>
    <div class="container">
      <h2>L·ªãch s·ª≠ ƒë∆°n h√†ng</h2>

      <table id="history-table">
        <thead>
          <tr>
            <th>M√£ ƒë∆°n</th>
            <th>Ng√†y ƒë·∫∑t</th>
            <th>T·ªïng ti·ªÅn</th>
            <th>Tr·∫°ng th√°i</th>
            <th>H√†nh ƒë·ªông</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Modal ƒë√°nh gi√° -->
    <div id="ratingModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeRatingModal()">√ó</span>
        <h2>ƒê√°nh gi√° ƒë∆°n h√†ng</h2>
        <p>Ch·ªçn s·ªë sao:</p>
        <div class="stars" id="stars">
          <span class="star" data-value="1">‚òÖ</span>
          <span class="star" data-value="2">‚òÖ</span>
          <span class="star" data-value="3">‚òÖ</span>
          <span class="star" data-value="4">‚òÖ</span>
          <span class="star" data-value="5">‚òÖ</span>
        </div>
        <div class="form-group">
          <label>N·ªôi dung ƒë√°nh gi√° (t√πy ch·ªçn):</label>
          <textarea
            id="ratingContent"
            rows="4"
            placeholder="Vi·∫øt c·∫£m nh·∫≠n c·ªßa b·∫°n..."
          ></textarea>
        </div>
        <button class="submit-btn" onclick="submitRating()">
          G·ª≠i ƒë√°nh gi√°
        </button>
      </div>
    </div>

    <!-- Modal chi ti·∫øt ƒë∆°n h√†ng -->
    <div id="detailModal" class="modal">
      <div class="modal-content">
        <span
          class="close"
          onclick="document.getElementById('detailModal').style.display='none'"
          >√ó</span
        >
        <h2>Chi ti·∫øt ƒë∆°n h√†ng</h2>
        <p id="detail-loading">ƒêang t·∫£i...</p>
        <table
          id="detail-table"
          style="
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            display: none;
          "
        >
          <thead>
            <tr>
              <th>Lo·∫°i</th>
              <th>T√™n</th>
              <th>Gi√°</th>
              <th>S·ªë l∆∞·ª£ng</th>
              <th>Th√†nh ti·ªÅn</th>
            </tr>
          </thead>
          <tbody id="detail-body"></tbody>
        </table>
        <p
          id="detail-total"
          style="margin-top: 15px; font-weight: bold; text-align: right"
        ></p>
      </div>
      <!-- Modal chi ti·∫øt ƒë∆°n h√†ng (th√™m v√†o cu·ªëi body, tr∆∞·ªõc </body>) -->
      <div id="detailModal" class="modal">
        <div class="modal-content">
          <span class="close" onclick="closeDetailModal()">√ó</span>
          <h2>Chi ti·∫øt ƒë∆°n h√†ng</h2>
          <p id="detail-loading">ƒêang t·∫£i...</p>
          <table
            id="detail-table"
            style="
              width: 100%;
              border-collapse: collapse;
              margin-top: 20px;
              display: none;
            "
          >
            <thead>
              <tr>
                <th>Lo·∫°i</th>
                <th>T√™n</th>
                <th>Gi√°</th>
                <th>S·ªë l∆∞·ª£ng</th>
                <th>Th√†nh ti·ªÅn</th>
              </tr>
            </thead>
            <tbody id="detail-body"></tbody>
          </table>
          <p
            id="order-total"
            style="margin-top: 15px; font-weight: bold; text-align: right"
          ></p>
        </div>
      </div>
    </div>

    <script>
      function loadUser() {
        const userArea = document.getElementById("user-area");
        const user = localStorage.getItem("user");

        if (!user) {
          userArea.innerHTML = `
        <a href="login.html" style="color: yellow;">ƒêƒÉng nh·∫≠p</a>
      `;
          return;
        }

        const u = JSON.parse(user);
        const name = u.hoTen || u.username || u.ten || null;

        if (name) {
          userArea.innerHTML = `
        Xin ch√†o, <b>${name}</b> |
        <a href="#" onclick="logout()" style="color: yellow;">ƒêƒÉng xu·∫•t</a>
      `;
        }
      }

      function logout() {
        localStorage.removeItem("user");
        alert("ƒê√£ ƒëƒÉng xu·∫•t!");
        loadUser();
      }
      loadUser();

      async function updateCartCount() {
        const user = JSON.parse(localStorage.getItem("user"));
        const cartCount = document.getElementById("cart-count");

        if (!user) {
          cartCount.innerText = 0;
          return;
        }

        try {
          const res = await fetch(
            `${window.API_BASE}/api/giohang/user/${user.maNguoiDung}`
          );

          if (!res.ok) throw new Error("Kh√¥ng l·∫•y ƒë∆∞·ª£c gi·ªè h√†ng");

          const data = await res.json();

          // data.chiTiet l√† danh s√°ch sp trong gi·ªè
          const total = data.chiTiet.reduce(
            (sum, item) => sum + item.SoLuong,
            0
          );

          cartCount.innerText = total;
        } catch (err) {
          console.error("L·ªói load cart count:", err);
          cartCount.innerText = 0;
        }
      }

      // G·ªçi khi t·∫£i trang
      updateCartCount();

      let currentRatingOrder = null;
      let selectedStars = 0;

      async function loadHistory() {
        const user = JSON.parse(localStorage.getItem("user"));
        if (!user) {
          document.querySelector("#history-table tbody").innerHTML =
            '<tr><td colspan="5">B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p</td></tr>';
          return;
        }

        const MaUser = user.MaUser;

        try {
          const res = await fetch(window.API_BASE + "/api/donhang");
          if (!res.ok) throw new Error("Kh√¥ng th·ªÉ l·∫•y l·ªãch s·ª≠");
          const allOrders = await res.json();

          const history = allOrders.filter(
            (o) =>
              o.MaUser === MaUser && ["hoan_thanh", "huy"].includes(o.TrangThai)
          );

          const tbody = document.querySelector("#history-table tbody");
          tbody.innerHTML = "";

          if (history.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="5">B·∫°n ch∆∞a c√≥ ƒë∆°n h√†ng n√†o ho√†n th√†nh ho·∫∑c b·ªã h·ªßy</td></tr>';
            return;
          }

          history.forEach(async (order) => {
            const statusText =
              order.TrangThai === "hoan_thanh" ? "Ho√†n th√†nh" : "ƒê√£ h·ªßy";

            let action = `
              <button class="btn btn-xem" onclick="openDetailModal('${order.MaDonHang}')">Xem chi ti·∫øt</button>
            `;

            if (order.TrangThai === "hoan_thanh") {
              // Ki·ªÉm tra ƒë√£ ƒë√°nh gi√° (kh√¥ng l√†m crash n·∫øu API l·ªói)
              let hasRated = false;
              try {
                const resCheck = await fetch(
                  `${window.API_BASE}/api/danhgia/check/${order.MaDonHang}/${MaUser}`
                );
                if (resCheck.ok) {
                  const data = await resCheck.json();
                  hasRated = data.alreadyRated;
                }
              } catch (checkErr) {
                console.warn("Kh√¥ng ki·ªÉm tra ƒë∆∞·ª£c ƒë√°nh gi√°:", checkErr);
              }

              if (hasRated) {
                action +=
                  '<button class="btn btn-da-danhgia" disabled>ƒê√£ ƒë√°nh gi√°</button>';
              } else {
                action += `<button class="btn btn-danhgia" onclick="openRatingModal('${order.MaDonHang}')">ƒê√°nh gi√°</button>`;
              }
            }

            tbody.innerHTML += `
              <tr>
                <td>${order.MaDonHang}</td>
                <td>${
                  order.NgayDat ? new Date(order.NgayDat).toLocaleString() : ""
                }</td>
                <td>${Number(order.TongTien).toLocaleString()}‚Ç´</td>
                <td class="status ${order.TrangThai}">${statusText}</td>
                <td>${action}</td>
              </tr>
            `;
          });
        } catch (err) {
          console.error("L·ªói t·∫£i l·ªãch s·ª≠:", err);
          document.querySelector("#history-table tbody").innerHTML =
            '<tr><td colspan="5">L·ªói t·∫£i d·ªØ li·ªáu: ' +
            err.message +
            "</td></tr>";
        }
      }

      // Modal ƒë√°nh gi√° (gi·ªØ nguy√™n)
      function openRatingModal(maDonHang) {
        currentRatingOrder = maDonHang;
        selectedStars = 0;
        document
          .querySelectorAll(".star")
          .forEach((s) => s.classList.remove("active"));
        document.getElementById("ratingContent").value = "";
        document.getElementById("ratingModal").style.display = "block";
      }

      function closeRatingModal() {
        document.getElementById("ratingModal").style.display = "none";
        currentRatingOrder = null;
      }

      document.querySelectorAll(".star").forEach((star) => {
        star.addEventListener("click", () => {
          selectedStars = parseInt(star.dataset.value);
          document.querySelectorAll(".star").forEach((s) => {
            s.classList.toggle(
              "active",
              parseInt(s.dataset.value) <= selectedStars
            );
          });
        });
      });

      async function submitRating() {
        if (selectedStars === 0) return alert("Vui l√≤ng ch·ªçn s·ªë sao!");
        const noiDung = document.getElementById("ratingContent").value.trim();

        try {
          const user = JSON.parse(localStorage.getItem("user"));
          const res = await fetch(window.API_BASE + "/api/danhgia", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              MaDonHang: currentRatingOrder,
              MaUser: user.MaUser,
              SoSao: selectedStars,
              NoiDung: noiDung,
            }),
          });

          if (!res.ok) {
            const errData = await res.json();
            throw new Error(errData.message || "G·ª≠i ƒë√°nh gi√° th·∫•t b·∫°i");
          }

          alert("C·∫£m ∆°n ƒë√°nh gi√° c·ªßa b·∫°n!");
          closeRatingModal();
          loadHistory();
        } catch (err) {
          alert("L·ªói: " + err.message);
        }
      }

      // M·ªü modal chi ti·∫øt
      function openDetailModal(maDonHang) {
        document.getElementById("detailModal").style.display = "block";
        loadDetail(maDonHang);
      }

      // ƒê√≥ng modal chi ti·∫øt
      function closeDetailModal() {
        document.getElementById("detailModal").style.display = "none";
      }

      // T·∫£i chi ti·∫øt ƒë∆°n h√†ng
      async function loadDetail(maDonHang) {
        try {
          document.getElementById("detail-loading").style.display = "block";
          document.getElementById("detail-table").style.display = "none";

          const res = await fetch(
            `${window.API_BASE}/api/donhangchitiet/donhang/${maDonHang}`
          );
          if (!res.ok) throw new Error("L·ªói l·∫•y chi ti·∫øt ƒë∆°n h√†ng");
          const items = await res.json();

          const tbody = document.getElementById("detail-body");
          tbody.innerHTML = "";

          let total = 0;
          items.forEach((item) => {
            const ten = item.TenSanPham || item.TenCombo || "S·∫£n ph·∫©m";
            const loai = item.LoaiSanPham || "Kh√°c";
            const thanhTien = item.ThanhTien || item.DonGia * item.SoLuong;
            total += thanhTien;

            tbody.innerHTML += `
        <tr>
          <td>${loai}</td>
          <td>${ten}</td>
          <td>${Number(item.DonGia).toLocaleString()}‚Ç´</td>
          <td>${item.SoLuong}</td>
          <td>${Number(thanhTien).toLocaleString()}‚Ç´</td>
        </tr>
      `;
          });

          document.getElementById(
            "order-total"
          ).innerHTML = `T·ªïng ti·ªÅn: ${Number(total).toLocaleString()}‚Ç´`;
          document.getElementById("detail-loading").style.display = "none";
          document.getElementById("detail-table").style.display = "table";
        } catch (err) {
          document.getElementById(
            "detail-loading"
          ).innerHTML = `L·ªói: ${err.message}`;
        }
      }
      loadHistory();
    </script>
  </body>
</html>
